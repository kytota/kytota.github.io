<!DOCTYPE html>
<html data-color-mode="light" data-dark-theme="dark" data-light-theme="light" lang="zh-CN">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="content-type" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link href='https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/Primer/21.0.7/primer.css' rel='stylesheet' />
    
    <link rel="icon" href="https://avatars.githubusercontent.com/u/117695866?v=4"><script>
        let theme = localStorage.getItem("meek_theme") || "light";
        document.documentElement.setAttribute("data-color-mode", theme);
    </script>
<meta name="description" content="# 提要
由于upload-labs下载来源不同，可能在靶场搭建时会出现无法上传的报错，可以进入源文件中查看是否有upload文件夹（跟pass01等同级），没有的话创建一个upload文件夹即可。">
<meta property="og:title" content="Upload-labs">
<meta property="og:description" content="# 提要
由于upload-labs下载来源不同，可能在靶场搭建时会出现无法上传的报错，可以进入源文件中查看是否有upload文件夹（跟pass01等同级），没有的话创建一个upload文件夹即可。">
<meta property="og:type" content="article">
<meta property="og:url" content="https://kytota.github.io/post/Upload-labs.html">
<meta property="og:image" content="https://avatars.githubusercontent.com/u/117695866?v=4">
<title>Upload-labs</title>
<link href="//unpkg.com/@wooorm/starry-night@2.1.1/style/both.css" rel="stylesheet" />


</head>
<style>
body{box-sizing: border-box;min-width: 200px;max-width: 900px;margin: 20px auto;padding: 45px;font-size: 16px;font-family: sans-serif;line-height: 1.25;}
#header{display:flex;padding-bottom:8px;border-bottom: 1px solid var(--borderColor-muted, var(--color-border-muted));margin-bottom: 16px;}
#footer {margin-top:64px; text-align: center;font-size: small;}

</style>

<style>
.postTitle{margin: auto 0;font-size:40px;font-weight:bold;}
.title-right{display:flex;margin:auto 0 0 auto;}
.title-right .circle{padding: 14px 16px;margin-right:8px;}
#postBody{border-bottom: 1px solid var(--color-border-default);padding-bottom:36px;}
#postBody hr{height:2px;}
#cmButton{height:48px;margin-top:48px;}
#comments{margin-top:64px;}
.g-emoji{font-size:24px;}
@media (max-width: 600px) {
    body {padding: 8px;}
    .postTitle{font-size:24px;}
}
.copy-feedback {
    display: none;
    position: absolute;
    top: 10px;
    right: 50px;
    color: var(--color-fg-on-emphasis);
    background-color: var(--color-fg-muted);
    border-radius: 3px;
    padding: 5px 8px;
    font-size: 12px;
}
</style>
<style>.markdown-alert{padding:0.5rem 1rem;margin-bottom:1rem;border-left:.25em solid var(--borderColor-default,var(--color-border-default));}.markdown-alert .markdown-alert-title {display:flex;font-weight:var(--base-text-weight-medium,500);align-items:center;line-height:1;}.markdown-alert>:first-child {margin-top:0;}.markdown-alert>:last-child {margin-bottom:0;}</style><style>.markdown-alert.markdown-alert-note {border-left-color:var(--borderColor-accent-emphasis, var(--color-accent-emphasis));background-color:var(--color-accent-subtle);}.markdown-alert.markdown-alert-note .markdown-alert-title {color: var(--fgColor-accent,var(--color-accent-fg));}</style>



<body>
    <div id="header">
<h1 class="postTitle">Upload-labs</h1>
<div class="title-right">
    <a href="https://kytota.github.io" id="buttonHome" class="btn btn-invisible circle" title="首页">
        <svg class="octicon" width="16" height="16">
            <path id="pathHome" fill-rule="evenodd"></path>
        </svg>
    </a>
    
    <a href="https://github.com/kytota/kytota.github.io/issues/1" target="_blank" class="btn btn-invisible circle" title="Issue">
        <svg class="octicon" width="16" height="16">
            <path id="pathIssue" fill-rule="evenodd"></path>
        </svg>
    </a>
    

    <a class="btn btn-invisible circle" onclick="modeSwitch();" title="切换主题">
        <svg class="octicon" width="16" height="16" >
            <path id="themeSwitch" fill-rule="evenodd"></path>
        </svg>
    </a>

</div>
</div>
    <div id="content">
<div class="markdown-body" id="postBody"><h1>提要</h1>
<p>由于upload-labs下载来源不同，可能在靶场搭建时会出现无法上传的报错，可以进入源文件中查看是否有upload文件夹（跟pass01等同级），没有的话创建一个upload文件夹即可。且不同关卡需要的php版本不同，有的关卡需要老版本不带nts的php，建议靶场搭建使用老版本的phpstudy~新人小白在学习过程中也会更新这篇提要</p>
<h1>目录</h1>
<p>-<a href="#pass01">pass01(前端绕过)</a><br>
-<a href="#pass02">pass02(MIME绕过)</a><br>
-<a href="#pass03">pass03(httpd-conf配置文件和php3)</a><br>
-<a href="#pass04">pass04(.htaccess文件)</a><br>
-<a href="#pass05pre">pass05pre</a><br>
-<a href="#pass05">pass05(.user.ini与php.ini)</a><br>
-<a href="#pass06">pass06(大小写绕过)</a><br>
-<a href="#pass07">pass07(空格绕过)</a></p>
<h1>pass01</h1>
<h2>源码展示</h2>
<div class="highlight highlight-text-html-basic"><pre class="notranslate">function checkFile() {
    var file = document.getElementsByName('upload_file')[0].value;
    if (file == null || file == "") {
        alert("请选择要上传的文件!");
        return false;
    }
    //定义允许上传的文件类型
    var allow_ext = ".jpg|.png|.gif";
    //提取上传文件的类型
    var ext_name = file.substring(file.lastIndexOf("."));
    //判断上传文件类型是否允许上传
    if (allow_ext.indexOf(ext_name + "|") == -1) {
        var errMsg = "该文件不允许上传，请上传" + allow_ext + "类型的文件,当前文件类型为：" + ext_name;
        alert(errMsg);
        return false;
    }
}</pre></div>
<h2>分析</h2>
<h3>代码分析</h3>
<p>从给出的源码可以看出只涉及前端</p>
<h3>抓包分析</h3>
<p>可以从bp抓包中查出端倪：<br>
先将bp的拦截打开，随后故意上传一个不符合源码要求的文件类型——即不属于jpg,png,gif的文件，点击上传后页面直接弹出警告框，且bp未收到请求包<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/user-attachments/assets/3054b267-70d5-4f9d-ab55-97e902efdca0"><img src="https://github.com/user-attachments/assets/3054b267-70d5-4f9d-ab55-97e902efdca0" alt="QQ20240819-001856" style="max-width: 100%;"></a><br>
，故可以判断为前端拦截。</p>
<h2>绕过方法</h2>
<p>由于前端只接受gif,png,jpg三种类型的文件，我们可以将自己的一句话木马后缀名改为jpg，<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/user-attachments/assets/f8bd77a1-a2b2-4626-939f-3c6488b01d3c"><img src="https://github.com/user-attachments/assets/f8bd77a1-a2b2-4626-939f-3c6488b01d3c" alt="QQ20240819-002301" style="max-width: 100%;"></a><br>
打开bp的拦截，随后进行上传，<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/user-attachments/assets/7963deab-ec07-4927-a9ed-c9cb62bbb5d5"><img src="https://github.com/user-attachments/assets/7963deab-ec07-4927-a9ed-c9cb62bbb5d5" alt="QQ20240819-002723" style="max-width: 100%;"></a><br>
在bp中将filename的用于绕过前端检测的jpg后缀名修改为木马原本的文件类型，如php，随后放行该请求包，回到upload-labs页面，可以看到上传成功<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/user-attachments/assets/a8a0f690-cbb4-490e-96a5-fe45379e1285"><img src="https://github.com/user-attachments/assets/a8a0f690-cbb4-490e-96a5-fe45379e1285" alt="QQ20240819-002759" style="max-width: 100%;"></a><br>
,为了验证，可以访问<a href="http://%E4%BD%A0%E7%9A%84ip/upload-labs/%E4%BD%A0%E7%9A%84%E6%9C%A8%E9%A9%AC%E6%96%87%E4%BB%B6%E5%90%8D%EF%BC%88%E5%9C%A8bp%E4%B8%AD%E4%BF%AE%E6%94%B9%E5%90%8E%E7%9A%84%EF%BC%89%EF%BC%8C%E7%9C%8B%E5%88%B0%E7%A9%BA%E7%99%BD%E7%9A%84%E9%A1%B5%E9%9D%A2%E4%B8%80%E8%88%AC%E5%B0%B1%E6%98%AF%E6%88%90%E5%8A%9F%E4%BA%86%EF%BC%8C%E5%A6%82%EF%BC%9A" rel="nofollow">http://你的ip/upload-labs/你的木马文件名（在bp中修改后的），看到空白的页面一般就是成功了，如：</a><br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/user-attachments/assets/de799a7d-3c7e-49c1-8ce1-424c73e4f272"><img src="https://github.com/user-attachments/assets/de799a7d-3c7e-49c1-8ce1-424c73e4f272" alt="QQ20240819-003057" style="max-width: 100%;"></a><br>
，当然也可以通过菜刀或者中国蚁剑进行连接操作，连接成功也说明木马上传成功！</p>
<h1>pass02</h1>
<h2>源码展示</h2>
<div class="highlight highlight-text-html-php"><pre class="notranslate"><span class="pl-s1"><span class="pl-c1">$</span>is_upload</span> = <span class="pl-c1">false</span>;
<span class="pl-s1"><span class="pl-c1">$</span>msg</span> = <span class="pl-c1">null</span>;
<span class="pl-k">if</span> (<span class="pl-en">isset</span>(<span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">_POST</span></span>[<span class="pl-s">'<span class="pl-s">submit</span>'</span>])) {
    <span class="pl-k">if</span> (<span class="pl-en">file_exists</span>(<span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">UPLOAD_ADDR</span></span>)) {
        <span class="pl-k">if</span> ((<span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">_FILES</span></span>[<span class="pl-s">'<span class="pl-s">upload_file</span>'</span>][<span class="pl-s">'<span class="pl-s">type</span>'</span>] == <span class="pl-s">'<span class="pl-s">image/jpeg</span>'</span>) || (<span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">_FILES</span></span>[<span class="pl-s">'<span class="pl-s">upload_file</span>'</span>][<span class="pl-s">'<span class="pl-s">type</span>'</span>] == <span class="pl-s">'<span class="pl-s">image/png</span>'</span>) || (<span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">_FILES</span></span>[<span class="pl-s">'<span class="pl-s">upload_file</span>'</span>][<span class="pl-s">'<span class="pl-s">type</span>'</span>] == <span class="pl-s">'<span class="pl-s">image/gif</span>'</span>)) {
            <span class="pl-k">if</span> (<span class="pl-en">move_uploaded_file</span>(<span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">_FILES</span></span>[<span class="pl-s">'<span class="pl-s">upload_file</span>'</span>][<span class="pl-s">'<span class="pl-s">tmp_name</span>'</span>], <span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">UPLOAD_ADDR</span></span> . <span class="pl-s">'<span class="pl-s">/</span>'</span> . <span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">_FILES</span></span>[<span class="pl-s">'<span class="pl-s">upload_file</span>'</span>][<span class="pl-s">'<span class="pl-s">name</span>'</span>])) {
                <span class="pl-s1"><span class="pl-c1">$</span>img_path</span> = <span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">UPLOAD_ADDR</span></span> . <span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">_FILES</span></span>[<span class="pl-s">'<span class="pl-s">upload_file</span>'</span>][<span class="pl-s">'<span class="pl-s">name</span>'</span>];
                <span class="pl-s1"><span class="pl-c1">$</span>is_upload</span> = <span class="pl-c1">true</span>;

            }
        } <span class="pl-k">else</span> {
            <span class="pl-s1"><span class="pl-c1">$</span>msg</span> = <span class="pl-s">'<span class="pl-s">文件类型不正确，请重新上传！</span>'</span>;
        }
    } <span class="pl-k">else</span> {
        <span class="pl-s1"><span class="pl-c1">$</span>msg</span> = <span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">UPLOAD_ADDR</span></span>.<span class="pl-s">'<span class="pl-s">文件夹不存在,请手工创建！</span>'</span>;
    }
}</pre></div>
<h2>分析</h2>
<p>从代码格式就可以看出这是后端的检测了，查看代码可以知道，只放行类型为</p>
<div class="highlight highlight-text-html-php"><pre class="notranslate"><span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">_FILES</span></span>[<span class="pl-s">'<span class="pl-s">upload_file</span>'</span>][<span class="pl-s">'<span class="pl-s">type</span>'</span>] == <span class="pl-s">'<span class="pl-s">image/jpeg</span>'</span>) || (<span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">_FILES</span></span>[<span class="pl-s">'<span class="pl-s">upload_file</span>'</span>][<span class="pl-s">'<span class="pl-s">type</span>'</span>] == <span class="pl-s">'<span class="pl-s">image/png</span>'</span>) || (<span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">_FILES</span></span>[<span class="pl-s">'<span class="pl-s">upload_file</span>'</span>][<span class="pl-s">'<span class="pl-s">type</span>'</span>] == '<span class="pl-s">image/gif</span>
<span class="pl-s"></span></pre></div>
<p>的文件，那这一句话是什么意思呢？询问gpt可以得知：</p>
<h3>1 $_FILES['upload_file']['type']</h3>
<p>$_FILES['upload_file']['type']是一个PHP超全局数组，用于处理通过HTTP POST方法上传的文件，假如我上传一个名为pass.php的文件夹</p>
<div class="highlight highlight-text-html-php"><pre class="notranslate"><span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">_FILES</span></span>[<span class="pl-s">'<span class="pl-s">upload_file</span>'</span>] = <span class="pl-en">array</span>(
    <span class="pl-s">'<span class="pl-s">name</span>'</span> =&gt; <span class="pl-s">'<span class="pl-s">pass.php</span>'</span>,          <span class="pl-c">// 上传文件的原始文件名</span>
    <span class="pl-s">'<span class="pl-s">type</span>'</span> =&gt; <span class="pl-s">'<span class="pl-s">text/plain</span>'</span>,        <span class="pl-c">// 文件的 MIME 类型（取决于服务器和浏览器的判断）</span>
    <span class="pl-s">'<span class="pl-s">tmp_name</span>'</span> =&gt; <span class="pl-s">'<span class="pl-s">/tmp/phpYzdqkD</span>'</span>,<span class="pl-c">// 文件上传后的临时存储路径</span>
    <span class="pl-s">'<span class="pl-s">error</span>'</span> =&gt; <span class="pl-c1">0</span>,                  <span class="pl-c">// 上传过程中出现的错误代码，0 表示没有错误</span>
    <span class="pl-s">'<span class="pl-s">size</span>'</span> =&gt; <span class="pl-c1">1234</span>                 // 文件的大小（以字节为单位）
);</pre></div>
<p>所以这串代码是先选择包含上传文件信息的upload_files，再选择其中的type</p>
<h3>2 MIME类型</h3>
<p>MIME用于描述文件的内容类型，当浏览器收到一个HTML文件时，MIME类型会告诉他这个文件的格式以及他应如何解析和现实内容<br>
MIME类型由两部分组成，用斜杠/分割</p>
<h4>主类型（type）：</h4>
<p>表示数据的主要类别。例如，text（文本文件）、image（图片文件）、application（应用程序数据）、audio（音频文件）、video（视频文件）等。</p>
<h4>子类型（subtype）：</h4>
<p>表示主类型中的具体格式。例如，plain 表示纯文本，jpeg 表示 JPEG 图片，json 表示 JSON 数据。</p>
<h3>3 对应BP</h3>
<p>在BP拦截到的请求包中，$_FILES['upload_file']通常在Content-Type或者Content-Disposition部分。</p>
<h2>绕过策略</h2>
<p>经过以上分析，我们知道可以通过BP拦截后修改请求包中的Content-Type或者Content-Disposition来满足源代码的要求即可。</p>
<h3>方法一</h3>
<p>这次没有前端检测，直接上传我们的一句话代码，如ip.php！<br>
打开BP拦截（养成习惯），回到网页选择ip.php木马进行上传，BP拦截后对Content-Type进行修改，改为png,jpg,gif的MIME类型放行<br>
上传成功！</p>
<h3>方法二</h3>
<p>其实可以直接按照Pass01的方法，先将木马后缀修改为png再进行上传，这是浏览器看到的MIME便符合要求了，但是同样的，一个png文件上传后，如果没有.htacess这类文件的帮助，其实是不能承担木马的功能的，所以还需要在BP中修改filename的后缀名为php。这里不做赘述，方法和Pass01一模一样。</p>
<h3>检测</h3>
<p>为了验证上传成功和木马文件内容的正确，继续访问 你的ip/upload-labs/upload/你上传的木马文件，查看到页面一面空白后说明一切正常<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/user-attachments/assets/56f9dd1c-f387-47bf-9536-45f106a8f475"><img src="https://github.com/user-attachments/assets/56f9dd1c-f387-47bf-9536-45f106a8f475" alt="QQ20240819-012404" style="max-width: 100%;"></a><br>
也可以通过中国蚁剑进行连接测试，连接成功说明任务圆满完成！</p>
<h1>pass03</h1>
<h2>注意</h2>
<p>这一关我个人认为是用于衔接下一关（第四关）的，请注意二者相关性，下面会谈到</p>
<h2>源码分析</h2>
<div class="highlight highlight-text-html-php"><pre class="notranslate"><span class="pl-s1"><span class="pl-c1">$</span>is_upload</span> = <span class="pl-c1">false</span>;
<span class="pl-s1"><span class="pl-c1">$</span>msg</span> = <span class="pl-c1">null</span>;
<span class="pl-k">if</span> (<span class="pl-en">isset</span>(<span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">_POST</span></span>[<span class="pl-s">'<span class="pl-s">submit</span>'</span>])) {
    <span class="pl-k">if</span> (<span class="pl-en">file_exists</span>(<span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">UPLOAD_ADDR</span></span>)) {
        <span class="pl-s1"><span class="pl-c1">$</span>deny_ext</span> = <span class="pl-en">array</span>(<span class="pl-s">'<span class="pl-s">.asp</span>'</span>,<span class="pl-s">'<span class="pl-s">.aspx</span>'</span>,<span class="pl-s">'<span class="pl-s">.php</span>'</span>,<span class="pl-s">'<span class="pl-s">.jsp</span>'</span>);
        <span class="pl-s1"><span class="pl-c1">$</span>file_name</span> = <span class="pl-en">trim</span>(<span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">_FILES</span></span>[<span class="pl-s">'<span class="pl-s">upload_file</span>'</span>][<span class="pl-s">'<span class="pl-s">name</span>'</span>]);
        <span class="pl-s1"><span class="pl-c1">$</span>file_name</span> = <span class="pl-en">deldot</span>(<span class="pl-s1"><span class="pl-c1">$</span>file_name</span>);<span class="pl-c">//删除文件名末尾的点</span>
        <span class="pl-s1"><span class="pl-c1">$</span>file_ext</span> = <span class="pl-en">strrchr</span>(<span class="pl-s1"><span class="pl-c1">$</span>file_name</span>, <span class="pl-s">'<span class="pl-s">.</span>'</span>);
        <span class="pl-s1"><span class="pl-c1">$</span>file_ext</span> = <span class="pl-en">strtolower</span>(<span class="pl-s1"><span class="pl-c1">$</span>file_ext</span>); <span class="pl-c">//转换为小写</span>
        <span class="pl-s1"><span class="pl-c1">$</span>file_ext</span> = <span class="pl-en">str_ireplace</span>(<span class="pl-s">'<span class="pl-s">::$DATA</span>'</span>, <span class="pl-s">''</span>, <span class="pl-s1"><span class="pl-c1">$</span>file_ext</span>);<span class="pl-c">//去除字符串::$DATA</span>
        <span class="pl-s1"><span class="pl-c1">$</span>file_ext</span> = <span class="pl-en">trim</span>(<span class="pl-s1"><span class="pl-c1">$</span>file_ext</span>); <span class="pl-c">//收尾去空</span>

        <span class="pl-k">if</span>(!<span class="pl-en">in_array</span>(<span class="pl-s1"><span class="pl-c1">$</span>file_ext</span>, <span class="pl-s1"><span class="pl-c1">$</span>deny_ext</span>)) {
            <span class="pl-k">if</span> (<span class="pl-en">move_uploaded_file</span>(<span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">_FILES</span></span>[<span class="pl-s">'<span class="pl-s">upload_file</span>'</span>][<span class="pl-s">'<span class="pl-s">tmp_name</span>'</span>], <span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">UPLOAD_ADDR</span></span>. <span class="pl-s">'<span class="pl-s">/</span>'</span> . <span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">_FILES</span></span>[<span class="pl-s">'<span class="pl-s">upload_file</span>'</span>][<span class="pl-s">'<span class="pl-s">name</span>'</span>])) {
                 <span class="pl-s1"><span class="pl-c1">$</span>img_path</span> = <span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">UPLOAD_ADDR</span></span> .<span class="pl-s">'<span class="pl-s">/</span>'</span>. <span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">_FILES</span></span>[<span class="pl-s">'<span class="pl-s">upload_file</span>'</span>][<span class="pl-s">'<span class="pl-s">name</span>'</span>];
                 <span class="pl-s1"><span class="pl-c1">$</span>is_upload</span> = <span class="pl-c1">true</span>;
            }
        } <span class="pl-k">else</span> {
            <span class="pl-s1"><span class="pl-c1">$</span>msg</span> = <span class="pl-s">'<span class="pl-s">不允许上传.asp,.aspx,.php,.jsp后缀文件！</span>'</span>;
        }
    } <span class="pl-k">else</span> {
        <span class="pl-s1"><span class="pl-c1">$</span>msg</span> = <span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">UPLOAD_ADDR</span></span> . <span class="pl-s">'<span class="pl-s">文件夹不存在,请手工创建！</span>'</span>;
    }
}</pre></div>
<p>分析可知，网站采用黑名单策略，并且防止了后缀名加点和空格的绕过手段（windows会将后缀名后的点和空格去掉，故也用于后缀名绕过），并且还防止了$DATA和大小写绕过，看似无懈可击。此时我们用前面打的方法进行绕过，会发现无法上传。无论如何都无法将php文件送入敌后了。<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/user-attachments/assets/49eefa31-c192-4f63-8e1c-8ab424d8ebe3"><img src="https://github.com/user-attachments/assets/49eefa31-c192-4f63-8e1c-8ab424d8ebe3" alt="QQ20240819-233301" style="max-width: 100%;"></a></p>
<h2>绕过策略</h2>
<p>此时，黑名单相较于白名单的劣势就体现出来了。网站黑名单只拒绝了四种后缀名的文件，但是可执行文件的后缀名海了去了！如我们想要将php文件送入却无计可施，完全可以用php3,php5,phtml文件绕过黑名单策略。</p>
<h3>注意</h3>
<p>重点来了，这里也是我为什么说这一关更像是 下一关的衔接 ，其本身思路不具备太多可行性，下面会体现出来<br>
为了让网站将php3,php5,phtml文件以解析php的方式解析，我们就要做如下调整：</p>
<h4>1</h4>
<p>在phpstudy中，将你的php的版本换成一个不带nts的ts版本<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/user-attachments/assets/2c9e912d-267b-4bb8-b521-15be338dfd55"><img src="https://github.com/user-attachments/assets/2c9e912d-267b-4bb8-b521-15be338dfd55" alt="屏幕截图 2024-08-19 233803" style="max-width: 100%;"></a><br>
nts是非多线程安全，ts是多线程安全，无需深究（因为我也不懂）。</p>
<h4>2</h4>
<p>在phpstudy中，找到apache的配置文件httpd.conf<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/user-attachments/assets/16ae242e-09cd-4d3e-a485-68f137baa36e"><img src="https://github.com/user-attachments/assets/16ae242e-09cd-4d3e-a485-68f137baa36e" alt="屏幕截图 2024-08-19 235204" style="max-width: 100%;"></a><br>
（phpstudy中寻找方式如图）<br>
进入文件，搜索 AddType application/x-httpd-php .php ，会找到一行被注释的代码<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/user-attachments/assets/a4520998-9342-47d9-8e9e-d692c98963a7"><img src="https://github.com/user-attachments/assets/a4520998-9342-47d9-8e9e-d692c98963a7" alt="QQ20240820-000812" style="max-width: 100%;"></a><br>
这段代码的意思是，将.pho后缀名的文件作为php解析。所以我们将#号删掉，在代码后加上我们想用于绕过的文件的后缀名：php3,php5,phtml。其实这时候你加上jpg和png后缀然后用图片上传木马也可以了，但我们还是按照靶场的思路来。修改此行代码为：</p>
<div class="highlight highlight-text-html-php"><pre class="notranslate"><span class="pl-v">AddType</span> application/x-httpd-php .php .phtml .php3 .php5</pre></div>
<h4>不可行原因</h4>
<p>看了以上两点我们应该会有感想：我修改配置文件是为了上传木马，可为了能上传木马我需要强大到可以修改配置文件。。。这就是这一关的不可行性了，但是这一关的思路：利用配置文件中的addtype和网站的黑名单漏洞，是具有可行性的，下一关我们将用.htaccess文件使这个想法具备可行性。</p>
<h3>开始绕过</h3>
<p>准备好我们的木马文件，老规矩，打开BP的拦截，上传文件，抓包，修改filename的后缀名为php3，放行，会发现文件就上传成功了。验证上传是否成功的方式和前两关一模一样，不再做赘述。</p>
<div class="markdown-alert markdown-alert-note"><p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p><p>最后再次提醒，请读懂下面这行代码：</p>
</div>
<div class="highlight highlight-text-html-php"><pre class="notranslate"><span class="pl-v">AddType</span> application/x-httpd-php .php .phtml</pre></div>
<h1>pass04</h1>
<h2>源代码展示</h2>
<div class="highlight highlight-text-html-php"><pre class="notranslate"><span class="pl-s1"><span class="pl-c1">$</span>is_upload</span> = <span class="pl-c1">false</span>;
<span class="pl-s1"><span class="pl-c1">$</span>msg</span> = <span class="pl-c1">null</span>;
<span class="pl-k">if</span> (<span class="pl-en">isset</span>(<span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">_POST</span></span>[<span class="pl-s">'<span class="pl-s">submit</span>'</span>])) {
    <span class="pl-k">if</span> (<span class="pl-en">file_exists</span>(<span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">UPLOAD_ADDR</span></span>)) {
        <span class="pl-s1"><span class="pl-c1">$</span>deny_ext</span> = <span class="pl-en">array</span>(<span class="pl-s">"<span class="pl-s">.php</span>"</span>,<span class="pl-s">"<span class="pl-s">.php5</span>"</span>,<span class="pl-s">"<span class="pl-s">.php4</span>"</span>,<span class="pl-s">"<span class="pl-s">.php3</span>"</span>,<span class="pl-s">"<span class="pl-s">.php2</span>"</span>,<span class="pl-s">"<span class="pl-s">php1</span>"</span>,<span class="pl-s">"<span class="pl-s">.html</span>"</span>,<span class="pl-s">"<span class="pl-s">.htm</span>"</span>,<span class="pl-s">"<span class="pl-s">.phtml</span>"</span>,<span class="pl-s">"<span class="pl-s">.pHp</span>"</span>,<span class="pl-s">"<span class="pl-s">.pHp5</span>"</span>,<span class="pl-s">"<span class="pl-s">.pHp4</span>"</span>,<span class="pl-s">"<span class="pl-s">.pHp3</span>"</span>,<span class="pl-s">"<span class="pl-s">.pHp2</span>"</span>,<span class="pl-s">"<span class="pl-s">pHp1</span>"</span>,<span class="pl-s">"<span class="pl-s">.Html</span>"</span>,<span class="pl-s">"<span class="pl-s">.Htm</span>"</span>,<span class="pl-s">"<span class="pl-s">.pHtml</span>"</span>,<span class="pl-s">"<span class="pl-s">.jsp</span>"</span>,<span class="pl-s">"<span class="pl-s">.jspa</span>"</span>,<span class="pl-s">"<span class="pl-s">.jspx</span>"</span>,<span class="pl-s">"<span class="pl-s">.jsw</span>"</span>,<span class="pl-s">"<span class="pl-s">.jsv</span>"</span>,<span class="pl-s">"<span class="pl-s">.jspf</span>"</span>,<span class="pl-s">"<span class="pl-s">.jtml</span>"</span>,<span class="pl-s">"<span class="pl-s">.jSp</span>"</span>,<span class="pl-s">"<span class="pl-s">.jSpx</span>"</span>,<span class="pl-s">"<span class="pl-s">.jSpa</span>"</span>,<span class="pl-s">"<span class="pl-s">.jSw</span>"</span>,<span class="pl-s">"<span class="pl-s">.jSv</span>"</span>,<span class="pl-s">"<span class="pl-s">.jSpf</span>"</span>,<span class="pl-s">"<span class="pl-s">.jHtml</span>"</span>,<span class="pl-s">"<span class="pl-s">.asp</span>"</span>,<span class="pl-s">"<span class="pl-s">.aspx</span>"</span>,<span class="pl-s">"<span class="pl-s">.asa</span>"</span>,<span class="pl-s">"<span class="pl-s">.asax</span>"</span>,<span class="pl-s">"<span class="pl-s">.ascx</span>"</span>,<span class="pl-s">"<span class="pl-s">.ashx</span>"</span>,<span class="pl-s">"<span class="pl-s">.asmx</span>"</span>,<span class="pl-s">"<span class="pl-s">.cer</span>"</span>,<span class="pl-s">"<span class="pl-s">.aSp</span>"</span>,<span class="pl-s">"<span class="pl-s">.aSpx</span>"</span>,<span class="pl-s">"<span class="pl-s">.aSa</span>"</span>,<span class="pl-s">"<span class="pl-s">.aSax</span>"</span>,<span class="pl-s">"<span class="pl-s">.aScx</span>"</span>,<span class="pl-s">"<span class="pl-s">.aShx</span>"</span>,<span class="pl-s">"<span class="pl-s">.aSmx</span>"</span>,<span class="pl-s">"<span class="pl-s">.cEr</span>"</span>,<span class="pl-s">"<span class="pl-s">.sWf</span>"</span>,<span class="pl-s">"<span class="pl-s">.swf</span>"</span>);
        <span class="pl-s1"><span class="pl-c1">$</span>file_name</span> = <span class="pl-en">trim</span>(<span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">_FILES</span></span>[<span class="pl-s">'<span class="pl-s">upload_file</span>'</span>][<span class="pl-s">'<span class="pl-s">name</span>'</span>]);
        <span class="pl-s1"><span class="pl-c1">$</span>file_name</span> = <span class="pl-en">deldot</span>(<span class="pl-s1"><span class="pl-c1">$</span>file_name</span>);<span class="pl-c">//删除文件名末尾的点</span>
        <span class="pl-s1"><span class="pl-c1">$</span>file_ext</span> = <span class="pl-en">strrchr</span>(<span class="pl-s1"><span class="pl-c1">$</span>file_name</span>, <span class="pl-s">'<span class="pl-s">.</span>'</span>);
        <span class="pl-s1"><span class="pl-c1">$</span>file_ext</span> = <span class="pl-en">strtolower</span>(<span class="pl-s1"><span class="pl-c1">$</span>file_ext</span>); <span class="pl-c">//转换为小写</span>
        <span class="pl-s1"><span class="pl-c1">$</span>file_ext</span> = <span class="pl-en">str_ireplace</span>(<span class="pl-s">'<span class="pl-s">::$DATA</span>'</span>, <span class="pl-s">''</span>, <span class="pl-s1"><span class="pl-c1">$</span>file_ext</span>);<span class="pl-c">//去除字符串::$DATA</span>
        <span class="pl-s1"><span class="pl-c1">$</span>file_ext</span> = <span class="pl-en">trim</span>(<span class="pl-s1"><span class="pl-c1">$</span>file_ext</span>); <span class="pl-c">//收尾去空</span>

        <span class="pl-k">if</span> (!<span class="pl-en">in_array</span>(<span class="pl-s1"><span class="pl-c1">$</span>file_ext</span>, <span class="pl-s1"><span class="pl-c1">$</span>deny_ext</span>)) {
            <span class="pl-k">if</span> (<span class="pl-en">move_uploaded_file</span>(<span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">_FILES</span></span>[<span class="pl-s">'<span class="pl-s">upload_file</span>'</span>][<span class="pl-s">'<span class="pl-s">tmp_name</span>'</span>], <span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">UPLOAD_ADDR</span></span> . <span class="pl-s">'<span class="pl-s">/</span>'</span> . <span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">_FILES</span></span>[<span class="pl-s">'<span class="pl-s">upload_file</span>'</span>][<span class="pl-s">'<span class="pl-s">name</span>'</span>])) {
                <span class="pl-s1"><span class="pl-c1">$</span>img_path</span> = <span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">UPLOAD_ADDR</span></span> . <span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">_FILES</span></span>[<span class="pl-s">'<span class="pl-s">upload_file</span>'</span>][<span class="pl-s">'<span class="pl-s">name</span>'</span>];
                <span class="pl-s1"><span class="pl-c1">$</span>is_upload</span> = <span class="pl-c1">true</span>;
            }
        } <span class="pl-k">else</span> {
            <span class="pl-s1"><span class="pl-c1">$</span>msg</span> = <span class="pl-s">'<span class="pl-s">此文件不允许上传!</span>'</span>;
        }
    } <span class="pl-k">else</span> {
        <span class="pl-s1"><span class="pl-c1">$</span>msg</span> = <span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">UPLOAD_ADDR</span></span> . <span class="pl-s">'<span class="pl-s">文件夹不存在,请手工创建！</span>'</span>;
    }
}</pre></div>
<h1>代码分析</h1>
<p>相较于第三关，这次网站在前者的基础上把php3等文件后缀名也纳入了黑名单。</p>
<h1>解决方案</h1>
<p>第三关为了使php3,php5,phtml文件被当做php文件解析，我们进入了apache的httpd-conf进行配置文件的修改，修改了代码</p>
<div class="highlight highlight-text-html-php"><pre class="notranslate"><span class="pl-v">AddType</span> application/x-httpd-php</pre></div>
<p>并且在其后方加上了.php3 .php5来使这类文件作为php文件被浏览器进行解析。事实上，httpd-conf的功能可以通过.htaccess文件来实现。</p>
<h2>httpd-conf和.htaceess文件的区别</h2>
<p><a target="_blank" rel="noopener noreferrer" href="https://github.com/user-attachments/assets/f24c2e86-b43d-40c1-b825-d95271243d9c"><img src="https://github.com/user-attachments/assets/f24c2e86-b43d-40c1-b825-d95271243d9c" alt="QQ20240822-181439" style="max-width: 100%;"></a><br>
(apache官网截的一些讲解)<br>
省流来说，apache中：一、httpd-conf是全局配置文件，而.htaceess是作用于其所在目录及其子目录中的配置文件；二、httpd-conf需要管理员级别的权限才能进行修改，且修改后需要重启服务器才能生效，而.htaccess文件可以通过我们的文本编辑器进行修改，且修改后即刻生效。</p>
<h2>如何上传.htaccess文件</h2>
<p>首先，我们要知道，我们上传.htaccess文件是为了修改网站的配置，让我们上传除了黑名单以外的文件类型时，仍然能够作为php文件进行解析。根据第三关我们知道，这涉及到</p>
<div class="highlight highlight-text-html-php"><pre class="notranslate"><span class="pl-v">AddType</span> application/x-httpd-php .php <span class="pl-c"># 增加这一类型的应用解释</span></pre></div>
<p>这一行代码，我们需要对其进行修改。但是这一配置已经在httpd-conf中，这时候我们再上传一个.htaccess对其进行修改，就涉及到对httpd-conf的override（覆盖）了，而httpd-conf中有一个变量AllowOverride，其值为None时是不允许对httpd-conf进行覆盖重写的，所以进入httpd-conf搜索AllowOverride查看其值，若是None就改为all即可。</p>
<h2>绕过展示</h2>
<h3>1.写一个.htaccess文件</h3>
<p><a target="_blank" rel="noopener noreferrer" href="https://github.com/user-attachments/assets/0de71edf-07dc-4db1-8e4e-0e2a5cc5cd79"><img src="https://github.com/user-attachments/assets/0de71edf-07dc-4db1-8e4e-0e2a5cc5cd79" alt="QQ20240822-193235" style="max-width: 100%;"></a></p>
<h3>2.上传.htaccess文件</h3>
<h3>3.准备好后缀名为.htaccess文件中对应后缀名的文件</h3>
<h3>4.上传</h3>
<p>可以发现上传成功（如果失败可能是php版本号的问题，参照pass03的版本号选择）</p>
<h1>pass05-pre</h1>
<h2>概念引入</h2>
<p>在pass03和pass04，我们了解了.htaccess分布式配置文件和httpd-conf全局配置文件。但有时候网站也会禁止.htaccess文件的上传，使我们无法修改和覆写httpd-conf中的配置。这时候user.ini文件就派上用场了。</p>
<h2>.user.ini文件</h2>
<p>打开phpstudy的配置文件，我们可以看到php.ini，这是php的主配置文件。而就像.htaccess之于httpd-conf，.user.ini和php.ini文件之前的关系就是分布式与全局的关系。</p>
<h2>.user.ini文件生效前提</h2>
<h3>一、php版本</h3>
<p>(在.user.ini文件的上传与使用中，我们应该尽量用新版本的php进行网站配置)<br>
在你的phpstudy的WWW文件夹根目录下写一个php文件</p>
<div class="highlight highlight-text-html-php"><pre class="notranslate"><span class="pl-ent">&lt;?php</span>
<span class="pl-en">phpinfo</span>();
<span class="pl-ent">?&gt;</span></pre></div>
<p><a target="_blank" rel="noopener noreferrer" href="https://github.com/user-attachments/assets/798b0135-209f-4271-b733-a04404805596"><img src="https://github.com/user-attachments/assets/798b0135-209f-4271-b733-a04404805596" alt="QQ20240824-180145" style="max-width: 100%;"></a></p>
<p>经过前面几关的学习，我们可以知道这个文件是为了显示php的版本及各种信息。之后在浏览器访问localhost/该文件名。</p>
<h4>老版本php(php 5.2.17)</h4>
<p><a target="_blank" rel="noopener noreferrer" href="https://github.com/user-attachments/assets/312be315-e56b-46c0-a98b-55949a89b601"><img src="https://github.com/user-attachments/assets/312be315-e56b-46c0-a98b-55949a89b601" alt="QQ20240824-180523" style="max-width: 100%;"></a></p>
<h4>新版本php(php7.0.12)</h4>
<p><a target="_blank" rel="noopener noreferrer" href="https://github.com/user-attachments/assets/56a692c6-cb39-49b8-b510-5541fddf8c0a"><img src="https://github.com/user-attachments/assets/56a692c6-cb39-49b8-b510-5541fddf8c0a" alt="QQ20240824-180619" style="max-width: 100%;"></a></p>
<p>为了使用.user.ini，我们需要server.api值为CGI/FastCGI，从上图可以看成新版本的才符合要求。(server.api可以理解为组件之间的协议，此处无需深究，我也不懂)</p>
<h3>二、所上传的文件目录中需要有可解析的php文件</h3>
<h1>pass05</h1>
<h2>源代码展示</h2>
<div class="highlight highlight-text-html-php"><pre class="notranslate"><span class="pl-s1"><span class="pl-c1">$</span>is_upload</span> = <span class="pl-c1">false</span>;
<span class="pl-s1"><span class="pl-c1">$</span>msg</span> = <span class="pl-c1">null</span>;
<span class="pl-k">if</span> (<span class="pl-en">isset</span>(<span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">_POST</span></span>[<span class="pl-s">'<span class="pl-s">submit</span>'</span>])) {
    <span class="pl-k">if</span> (<span class="pl-en">file_exists</span>(<span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">UPLOAD_ADDR</span></span>)) {
        <span class="pl-s1"><span class="pl-c1">$</span>deny_ext</span> = <span class="pl-en">array</span>(<span class="pl-s">"<span class="pl-s">.php</span>"</span>,<span class="pl-s">"<span class="pl-s">.php5</span>"</span>,<span class="pl-s">"<span class="pl-s">.php4</span>"</span>,<span class="pl-s">"<span class="pl-s">.php3</span>"</span>,<span class="pl-s">"<span class="pl-s">.php2</span>"</span>,<span class="pl-s">"<span class="pl-s">.html</span>"</span>,<span class="pl-s">"<span class="pl-s">.htm</span>"</span>,<span class="pl-s">"<span class="pl-s">.phtml</span>"</span>,<span class="pl-s">"<span class="pl-s">.pHp</span>"</span>,<span class="pl-s">"<span class="pl-s">.pHp5</span>"</span>,<span class="pl-s">"<span class="pl-s">.pHp4</span>"</span>,<span class="pl-s">"<span class="pl-s">.pHp3</span>"</span>,<span class="pl-s">"<span class="pl-s">.pHp2</span>"</span>,<span class="pl-s">"<span class="pl-s">.Html</span>"</span>,<span class="pl-s">"<span class="pl-s">.Htm</span>"</span>,<span class="pl-s">"<span class="pl-s">.pHtml</span>"</span>,<span class="pl-s">"<span class="pl-s">.jsp</span>"</span>,<span class="pl-s">"<span class="pl-s">.jspa</span>"</span>,<span class="pl-s">"<span class="pl-s">.jspx</span>"</span>,<span class="pl-s">"<span class="pl-s">.jsw</span>"</span>,<span class="pl-s">"<span class="pl-s">.jsv</span>"</span>,<span class="pl-s">"<span class="pl-s">.jspf</span>"</span>,<span class="pl-s">"<span class="pl-s">.jtml</span>"</span>,<span class="pl-s">"<span class="pl-s">.jSp</span>"</span>,<span class="pl-s">"<span class="pl-s">.jSpx</span>"</span>,<span class="pl-s">"<span class="pl-s">.jSpa</span>"</span>,<span class="pl-s">"<span class="pl-s">.jSw</span>"</span>,<span class="pl-s">"<span class="pl-s">.jSv</span>"</span>,<span class="pl-s">"<span class="pl-s">.jSpf</span>"</span>,<span class="pl-s">"<span class="pl-s">.jHtml</span>"</span>,<span class="pl-s">"<span class="pl-s">.asp</span>"</span>,<span class="pl-s">"<span class="pl-s">.aspx</span>"</span>,<span class="pl-s">"<span class="pl-s">.asa</span>"</span>,<span class="pl-s">"<span class="pl-s">.asax</span>"</span>,<span class="pl-s">"<span class="pl-s">.ascx</span>"</span>,<span class="pl-s">"<span class="pl-s">.ashx</span>"</span>,<span class="pl-s">"<span class="pl-s">.asmx</span>"</span>,<span class="pl-s">"<span class="pl-s">.cer</span>"</span>,<span class="pl-s">"<span class="pl-s">.aSp</span>"</span>,<span class="pl-s">"<span class="pl-s">.aSpx</span>"</span>,<span class="pl-s">"<span class="pl-s">.aSa</span>"</span>,<span class="pl-s">"<span class="pl-s">.aSax</span>"</span>,<span class="pl-s">"<span class="pl-s">.aScx</span>"</span>,<span class="pl-s">"<span class="pl-s">.aShx</span>"</span>,<span class="pl-s">"<span class="pl-s">.aSmx</span>"</span>,<span class="pl-s">"<span class="pl-s">.cEr</span>"</span>,<span class="pl-s">"<span class="pl-s">.sWf</span>"</span>,<span class="pl-s">"<span class="pl-s">.swf</span>"</span>,<span class="pl-s">"<span class="pl-s">.htaccess</span>"</span>);
        <span class="pl-s1"><span class="pl-c1">$</span>file_name</span> = <span class="pl-en">trim</span>(<span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">_FILES</span></span>[<span class="pl-s">'<span class="pl-s">upload_file</span>'</span>][<span class="pl-s">'<span class="pl-s">name</span>'</span>]);
        <span class="pl-s1"><span class="pl-c1">$</span>file_ext</span> = <span class="pl-en">strrchr</span>(<span class="pl-s1"><span class="pl-c1">$</span>file_name</span>, <span class="pl-s">'<span class="pl-s">.</span>'</span>);
        <span class="pl-s1"><span class="pl-c1">$</span>file_ext</span> = <span class="pl-en">strtolower</span>(<span class="pl-s1"><span class="pl-c1">$</span>file_ext</span>); <span class="pl-c">//转换为小写</span>
        <span class="pl-s1"><span class="pl-c1">$</span>file_ext</span> = <span class="pl-en">str_ireplace</span>(<span class="pl-s">'<span class="pl-s">::$DATA</span>'</span>, <span class="pl-s">''</span>, <span class="pl-s1"><span class="pl-c1">$</span>file_ext</span>);<span class="pl-c">//去除字符串::$DATA</span>
        <span class="pl-s1"><span class="pl-c1">$</span>file_ext</span> = <span class="pl-en">trim</span>(<span class="pl-s1"><span class="pl-c1">$</span>file_ext</span>); <span class="pl-c">//首尾去空</span>
        
        <span class="pl-k">if</span> (!<span class="pl-en">in_array</span>(<span class="pl-s1"><span class="pl-c1">$</span>file_ext</span>, <span class="pl-s1"><span class="pl-c1">$</span>deny_ext</span>)) {
            <span class="pl-k">if</span> (<span class="pl-en">move_uploaded_file</span>(<span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">_FILES</span></span>[<span class="pl-s">'<span class="pl-s">upload_file</span>'</span>][<span class="pl-s">'<span class="pl-s">tmp_name</span>'</span>], <span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">UPLOAD_ADDR</span></span> . <span class="pl-s">'<span class="pl-s">/</span>'</span> . <span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">_FILES</span></span>[<span class="pl-s">'<span class="pl-s">upload_file</span>'</span>][<span class="pl-s">'<span class="pl-s">name</span>'</span>])) {
                <span class="pl-s1"><span class="pl-c1">$</span>img_path</span> = <span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">UPLOAD_ADDR</span></span> . <span class="pl-s">'<span class="pl-s">/</span>'</span> . <span class="pl-s1"><span class="pl-c1">$</span>file_name</span>;
                <span class="pl-s1"><span class="pl-c1">$</span>is_upload</span> = <span class="pl-c1">true</span>;
            }
        } <span class="pl-k">else</span> {
            <span class="pl-s1"><span class="pl-c1">$</span>msg</span> = <span class="pl-s">'<span class="pl-s">此文件不允许上传</span>'</span>;
        }
    } <span class="pl-k">else</span> {
        <span class="pl-s1"><span class="pl-c1">$</span>msg</span> = <span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">UPLOAD_ADDR</span></span> . <span class="pl-s">'<span class="pl-s">文件夹不存在,请手工创建！</span>'</span>;
    }
}</pre></div>
<h2>分析绕过策略</h2>
<p>注意到，本次网站禁止了.htaccess文件的上传。基于pass04pre的讲解，我们可以使用.user.ini进行绕过</p>
<h3>.user.ini写法</h3>
<div class="highlight highlight-text-html-php"><pre class="notranslate"><span class="pl-v">Auto_prepend_file</span>=xxx.xxx <span class="pl-c">#使所有当前目录及其子目录中的php文件优先包含xxx.xxx这个文件（即将xxx.xxx文件加入每个在目录范围内的php文件，跟着php文件一同被以php的方式解析）</span></pre></div>
<h2>绕过策略</h2>
<p>首先，检查我们的靶场文件的upload文件夹中是否已经有readme.php文件，这本应该是靶场内置的，但是由于我们获取靶场的方式各有不同，所以可能有人没有这个php文件（比如我就压根没有upload这个上传文件夹，upload文件夹都是我自己创建的，更别指望里面会有自带的readme.php了），没有这个文件的话我们创建一个空readme.php文件即可（当然不一定非得名字叫readme，举一反三嘛），因为正如pass05pre中所说，.user,ini文件要生效的话，其所在目录必须包含php文件。<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/user-attachments/assets/dcddda10-d53f-4a92-b46a-863dfbcf4f5d"><img src="https://github.com/user-attachments/assets/dcddda10-d53f-4a92-b46a-863dfbcf4f5d" alt="QQ20240824-224350" style="max-width: 100%;"></a><br>
确保uoload路径下有可用的php文件后，我们开始编写.user.ini</p>
<h3>.user.ini从创建到使用</h3>
<h4>写法</h4>
<div class="highlight highlight-text-html-php"><pre class="notranslate"><span class="pl-v">Auto_prepend_file</span>=pass.jpg <span class="pl-c">#这里我所用的木马名是pass.jpg</span></pre></div>
<p>写好后上传，由于黑名单中未包含.user,ini，所以很顺利的，上传成功。<br>
（上传成功）</p>
<h4>运用</h4>
<p>由于我的.user.ini中用于被包含的木马文件名为pass.jpg，所以我们将我们的木马文件复制一份并将文件名改为pass.jpg，随后上传。</p>
<p>这时候，我们用浏览器解析readme.php文件时，其会将木马文件pass.jpg一并解析。</p>
<h2>检验</h2>
<p>用中国蚁剑进行连接，发现成功。<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/user-attachments/assets/89b34bd2-4327-4321-9eb2-923d267ab60e"><img src="https://github.com/user-attachments/assets/89b34bd2-4327-4321-9eb2-923d267ab60e" alt="QQ20240824-225216" style="max-width: 100%;"></a></p>
<h1>pass06</h1>
<h2>源代码展示</h2>
<div class="highlight highlight-text-html-php"><pre class="notranslate"><span class="pl-s1"><span class="pl-c1">$</span>is_upload</span> = <span class="pl-c1">false</span>;
<span class="pl-s1"><span class="pl-c1">$</span>msg</span> = <span class="pl-c1">null</span>;
<span class="pl-k">if</span> (<span class="pl-en">isset</span>(<span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">_POST</span></span>[<span class="pl-s">'<span class="pl-s">submit</span>'</span>])) {
    <span class="pl-k">if</span> (<span class="pl-en">file_exists</span>(<span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">UPLOAD_ADDR</span></span>)) {
        <span class="pl-s1"><span class="pl-c1">$</span>deny_ext</span> = <span class="pl-en">array</span>(<span class="pl-s">"<span class="pl-s">.php</span>"</span>,<span class="pl-s">"<span class="pl-s">.php5</span>"</span>,<span class="pl-s">"<span class="pl-s">.php4</span>"</span>,<span class="pl-s">"<span class="pl-s">.php3</span>"</span>,<span class="pl-s">"<span class="pl-s">.php2</span>"</span>,<span class="pl-s">"<span class="pl-s">.html</span>"</span>,<span class="pl-s">"<span class="pl-s">.htm</span>"</span>,<span class="pl-s">"<span class="pl-s">.phtml</span>"</span>,<span class="pl-s">"<span class="pl-s">.pHp</span>"</span>,<span class="pl-s">"<span class="pl-s">.pHp5</span>"</span>,<span class="pl-s">"<span class="pl-s">.pHp4</span>"</span>,<span class="pl-s">"<span class="pl-s">.pHp3</span>"</span>,<span class="pl-s">"<span class="pl-s">.pHp2</span>"</span>,<span class="pl-s">"<span class="pl-s">.Html</span>"</span>,<span class="pl-s">"<span class="pl-s">.Htm</span>"</span>,<span class="pl-s">"<span class="pl-s">.pHtml</span>"</span>,<span class="pl-s">"<span class="pl-s">.jsp</span>"</span>,<span class="pl-s">"<span class="pl-s">.jspa</span>"</span>,<span class="pl-s">"<span class="pl-s">.jspx</span>"</span>,<span class="pl-s">"<span class="pl-s">.jsw</span>"</span>,<span class="pl-s">"<span class="pl-s">.jsv</span>"</span>,<span class="pl-s">"<span class="pl-s">.jspf</span>"</span>,<span class="pl-s">"<span class="pl-s">.jtml</span>"</span>,<span class="pl-s">"<span class="pl-s">.jSp</span>"</span>,<span class="pl-s">"<span class="pl-s">.jSpx</span>"</span>,<span class="pl-s">"<span class="pl-s">.jSpa</span>"</span>,<span class="pl-s">"<span class="pl-s">.jSw</span>"</span>,<span class="pl-s">"<span class="pl-s">.jSv</span>"</span>,<span class="pl-s">"<span class="pl-s">.jSpf</span>"</span>,<span class="pl-s">"<span class="pl-s">.jHtml</span>"</span>,<span class="pl-s">"<span class="pl-s">.asp</span>"</span>,<span class="pl-s">"<span class="pl-s">.aspx</span>"</span>,<span class="pl-s">"<span class="pl-s">.asa</span>"</span>,<span class="pl-s">"<span class="pl-s">.asax</span>"</span>,<span class="pl-s">"<span class="pl-s">.ascx</span>"</span>,<span class="pl-s">"<span class="pl-s">.ashx</span>"</span>,<span class="pl-s">"<span class="pl-s">.asmx</span>"</span>,<span class="pl-s">"<span class="pl-s">.cer</span>"</span>,<span class="pl-s">"<span class="pl-s">.aSp</span>"</span>,<span class="pl-s">"<span class="pl-s">.aSpx</span>"</span>,<span class="pl-s">"<span class="pl-s">.aSa</span>"</span>,<span class="pl-s">"<span class="pl-s">.aSax</span>"</span>,<span class="pl-s">"<span class="pl-s">.aScx</span>"</span>,<span class="pl-s">"<span class="pl-s">.aShx</span>"</span>,<span class="pl-s">"<span class="pl-s">.aSmx</span>"</span>,<span class="pl-s">"<span class="pl-s">.cEr</span>"</span>,<span class="pl-s">"<span class="pl-s">.sWf</span>"</span>,<span class="pl-s">"<span class="pl-s">.swf</span>"</span>,<span class="pl-s">"<span class="pl-s">.htaccess</span>"</span>);
        <span class="pl-s1"><span class="pl-c1">$</span>file_name</span> = <span class="pl-en">trim</span>(<span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">_FILES</span></span>[<span class="pl-s">'<span class="pl-s">upload_file</span>'</span>][<span class="pl-s">'<span class="pl-s">name</span>'</span>]);
        <span class="pl-s1"><span class="pl-c1">$</span>file_name</span> = <span class="pl-en">deldot</span>(<span class="pl-s1"><span class="pl-c1">$</span>file_name</span>);<span class="pl-c">//删除文件名末尾的点</span>
        <span class="pl-s1"><span class="pl-c1">$</span>file_ext</span> = <span class="pl-en">strrchr</span>(<span class="pl-s1"><span class="pl-c1">$</span>file_name</span>, <span class="pl-s">'<span class="pl-s">.</span>'</span>);
        <span class="pl-s1"><span class="pl-c1">$</span>file_ext</span> = <span class="pl-en">str_ireplace</span>(<span class="pl-s">'<span class="pl-s">::$DATA</span>'</span>, <span class="pl-s">''</span>, <span class="pl-s1"><span class="pl-c1">$</span>file_ext</span>);<span class="pl-c">//去除字符串::$DATA</span>
        <span class="pl-s1"><span class="pl-c1">$</span>file_ext</span> = <span class="pl-en">trim</span>(<span class="pl-s1"><span class="pl-c1">$</span>file_ext</span>); <span class="pl-c">//首尾去空</span>

        <span class="pl-k">if</span> (!<span class="pl-en">in_array</span>(<span class="pl-s1"><span class="pl-c1">$</span>file_ext</span>, <span class="pl-s1"><span class="pl-c1">$</span>deny_ext</span>)) {
            <span class="pl-k">if</span> (<span class="pl-en">move_uploaded_file</span>(<span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">_FILES</span></span>[<span class="pl-s">'<span class="pl-s">upload_file</span>'</span>][<span class="pl-s">'<span class="pl-s">tmp_name</span>'</span>], <span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">UPLOAD_ADDR</span></span> . <span class="pl-s">'<span class="pl-s">/</span>'</span> . <span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">_FILES</span></span>[<span class="pl-s">'<span class="pl-s">upload_file</span>'</span>][<span class="pl-s">'<span class="pl-s">name</span>'</span>])) {
                <span class="pl-s1"><span class="pl-c1">$</span>img_path</span> = <span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">UPLOAD_ADDR</span></span> . <span class="pl-s">'<span class="pl-s">/</span>'</span> . <span class="pl-s1"><span class="pl-c1">$</span>file_name</span>;
                <span class="pl-s1"><span class="pl-c1">$</span>is_upload</span> = <span class="pl-c1">true</span>;
            }
        } <span class="pl-k">else</span> {
            <span class="pl-s1"><span class="pl-c1">$</span>msg</span> = <span class="pl-s">'<span class="pl-s">此文件不允许上传</span>'</span>;
        }
    } <span class="pl-k">else</span> {
        <span class="pl-s1"><span class="pl-c1">$</span>msg</span> = <span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">UPLOAD_ADDR</span></span> . <span class="pl-s">'<span class="pl-s">文件夹不存在,请手工创建！</span>'</span>;
    }
}</pre></div>
<h2>代码分析</h2>
<p>我们可以发现一个致命且显眼的漏洞：没有预防大小写，因此本关难度极低</p>
<h2>绕过策略</h2>
<p>对此我们可以用后缀名大小写混写绕过<br>
，太简单，直接贴图~<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/user-attachments/assets/88e155ec-23e1-4e9c-8937-8d0c67efe8dd"><img src="https://github.com/user-attachments/assets/88e155ec-23e1-4e9c-8937-8d0c67efe8dd" alt="QQ20240824-232005" style="max-width: 100%;"></a><br>
我们先开启BP进行抓包，再上传一个名为ip.php的文件，拦截到请求包后对后缀名进行修改，改为ip.pHP,发现上传成功</p>
<h2>检验</h2>
<p>通过中国蚁剑进行连接<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/user-attachments/assets/22d915d8-3346-4396-8bf2-85d246f72088"><img src="https://github.com/user-attachments/assets/22d915d8-3346-4396-8bf2-85d246f72088" alt="QQ20240824-232830" style="max-width: 100%;"></a><br>
成功！</p>
<h1>pass07</h1>
<h2>源代码展示</h2>
<div class="highlight highlight-text-html-php"><pre class="notranslate"><span class="pl-s1"><span class="pl-c1">$</span>is_upload</span> = <span class="pl-c1">false</span>;
<span class="pl-s1"><span class="pl-c1">$</span>msg</span> = <span class="pl-c1">null</span>;
<span class="pl-k">if</span> (<span class="pl-en">isset</span>(<span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">_POST</span></span>[<span class="pl-s">'<span class="pl-s">submit</span>'</span>])) {
    <span class="pl-k">if</span> (<span class="pl-en">file_exists</span>(<span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">UPLOAD_ADDR</span></span>)) {
        <span class="pl-s1"><span class="pl-c1">$</span>deny_ext</span> = <span class="pl-en">array</span>(<span class="pl-s">"<span class="pl-s">.php</span>"</span>,<span class="pl-s">"<span class="pl-s">.php5</span>"</span>,<span class="pl-s">"<span class="pl-s">.php4</span>"</span>,<span class="pl-s">"<span class="pl-s">.php3</span>"</span>,<span class="pl-s">"<span class="pl-s">.php2</span>"</span>,<span class="pl-s">"<span class="pl-s">.html</span>"</span>,<span class="pl-s">"<span class="pl-s">.htm</span>"</span>,<span class="pl-s">"<span class="pl-s">.phtml</span>"</span>,<span class="pl-s">"<span class="pl-s">.pHp</span>"</span>,<span class="pl-s">"<span class="pl-s">.pHp5</span>"</span>,<span class="pl-s">"<span class="pl-s">.pHp4</span>"</span>,<span class="pl-s">"<span class="pl-s">.pHp3</span>"</span>,<span class="pl-s">"<span class="pl-s">.pHp2</span>"</span>,<span class="pl-s">"<span class="pl-s">.Html</span>"</span>,<span class="pl-s">"<span class="pl-s">.Htm</span>"</span>,<span class="pl-s">"<span class="pl-s">.pHtml</span>"</span>,<span class="pl-s">"<span class="pl-s">.jsp</span>"</span>,<span class="pl-s">"<span class="pl-s">.jspa</span>"</span>,<span class="pl-s">"<span class="pl-s">.jspx</span>"</span>,<span class="pl-s">"<span class="pl-s">.jsw</span>"</span>,<span class="pl-s">"<span class="pl-s">.jsv</span>"</span>,<span class="pl-s">"<span class="pl-s">.jspf</span>"</span>,<span class="pl-s">"<span class="pl-s">.jtml</span>"</span>,<span class="pl-s">"<span class="pl-s">.jSp</span>"</span>,<span class="pl-s">"<span class="pl-s">.jSpx</span>"</span>,<span class="pl-s">"<span class="pl-s">.jSpa</span>"</span>,<span class="pl-s">"<span class="pl-s">.jSw</span>"</span>,<span class="pl-s">"<span class="pl-s">.jSv</span>"</span>,<span class="pl-s">"<span class="pl-s">.jSpf</span>"</span>,<span class="pl-s">"<span class="pl-s">.jHtml</span>"</span>,<span class="pl-s">"<span class="pl-s">.asp</span>"</span>,<span class="pl-s">"<span class="pl-s">.aspx</span>"</span>,<span class="pl-s">"<span class="pl-s">.asa</span>"</span>,<span class="pl-s">"<span class="pl-s">.asax</span>"</span>,<span class="pl-s">"<span class="pl-s">.ascx</span>"</span>,<span class="pl-s">"<span class="pl-s">.ashx</span>"</span>,<span class="pl-s">"<span class="pl-s">.asmx</span>"</span>,<span class="pl-s">"<span class="pl-s">.cer</span>"</span>,<span class="pl-s">"<span class="pl-s">.aSp</span>"</span>,<span class="pl-s">"<span class="pl-s">.aSpx</span>"</span>,<span class="pl-s">"<span class="pl-s">.aSa</span>"</span>,<span class="pl-s">"<span class="pl-s">.aSax</span>"</span>,<span class="pl-s">"<span class="pl-s">.aScx</span>"</span>,<span class="pl-s">"<span class="pl-s">.aShx</span>"</span>,<span class="pl-s">"<span class="pl-s">.aSmx</span>"</span>,<span class="pl-s">"<span class="pl-s">.cEr</span>"</span>,<span class="pl-s">"<span class="pl-s">.sWf</span>"</span>,<span class="pl-s">"<span class="pl-s">.swf</span>"</span>,<span class="pl-s">"<span class="pl-s">.htaccess</span>"</span>);
        <span class="pl-s1"><span class="pl-c1">$</span>file_name</span> = <span class="pl-en">trim</span>(<span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">_FILES</span></span>[<span class="pl-s">'<span class="pl-s">upload_file</span>'</span>][<span class="pl-s">'<span class="pl-s">name</span>'</span>]);
        <span class="pl-s1"><span class="pl-c1">$</span>file_name</span> = <span class="pl-en">deldot</span>(<span class="pl-s1"><span class="pl-c1">$</span>file_name</span>);<span class="pl-c">//删除文件名末尾的点</span>
        <span class="pl-s1"><span class="pl-c1">$</span>file_ext</span> = <span class="pl-en">strrchr</span>(<span class="pl-s1"><span class="pl-c1">$</span>file_name</span>, <span class="pl-s">'<span class="pl-s">.</span>'</span>);
        <span class="pl-s1"><span class="pl-c1">$</span>file_ext</span> = <span class="pl-en">strtolower</span>(<span class="pl-s1"><span class="pl-c1">$</span>file_ext</span>); <span class="pl-c">//转换为小写</span>
        <span class="pl-s1"><span class="pl-c1">$</span>file_ext</span> = <span class="pl-en">str_ireplace</span>(<span class="pl-s">'<span class="pl-s">::$DATA</span>'</span>, <span class="pl-s">''</span>, <span class="pl-s1"><span class="pl-c1">$</span>file_ext</span>);<span class="pl-c">//去除字符串::$DATA</span>
        
        <span class="pl-k">if</span> (!<span class="pl-en">in_array</span>(<span class="pl-s1"><span class="pl-c1">$</span>file_ext</span>, <span class="pl-s1"><span class="pl-c1">$</span>deny_ext</span>)) {
            <span class="pl-k">if</span> (<span class="pl-en">move_uploaded_file</span>(<span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">_FILES</span></span>[<span class="pl-s">'<span class="pl-s">upload_file</span>'</span>][<span class="pl-s">'<span class="pl-s">tmp_name</span>'</span>], <span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">UPLOAD_ADDR</span></span> . <span class="pl-s">'<span class="pl-s">/</span>'</span> . <span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">_FILES</span></span>[<span class="pl-s">'<span class="pl-s">upload_file</span>'</span>][<span class="pl-s">'<span class="pl-s">name</span>'</span>])) {
                <span class="pl-s1"><span class="pl-c1">$</span>img_path</span> = <span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">UPLOAD_ADDR</span></span> . <span class="pl-s">'<span class="pl-s">/</span>'</span> . <span class="pl-s1"><span class="pl-c1">$</span>file_name</span>;
                <span class="pl-s1"><span class="pl-c1">$</span>is_upload</span> = <span class="pl-c1">true</span>;
            }
        } <span class="pl-k">else</span> {
            <span class="pl-s1"><span class="pl-c1">$</span>msg</span> = <span class="pl-s">'<span class="pl-s">此文件不允许上传</span>'</span>;
        }
    } <span class="pl-k">else</span> {
        <span class="pl-s1"><span class="pl-c1">$</span>msg</span> = <span class="pl-s1"><span class="pl-c1">$</span><span class="pl-c1">UPLOAD_ADDR</span></span> . <span class="pl-s">'<span class="pl-s">文件夹不存在,请手工创建！</span>'</span>;
    }
}</pre></div>
<h2>绕过策略分析</h2>
<p>通过网站源码我们可以看到网站的巨大漏洞：没有防止空格绕过！所以同样本关非常简单，在要上传的木马文件名后缀加上空格即可。</p>
<h2>绕过策略</h2>
<h3>1.打开BP拦截</h3>
<p><a target="_blank" rel="noopener noreferrer" href="https://github.com/user-attachments/assets/10d7a901-b059-446b-bc0b-140ddfbfe88d"><img src="https://github.com/user-attachments/assets/10d7a901-b059-446b-bc0b-140ddfbfe88d" alt="QQ20240825-095458" style="max-width: 100%;"></a></p>
<h3>2.上传我们的木马文件</h3>
<h3>3.进入BP中，修改拦截到的请求包，在filename的后缀名后加上空格。</h3>
<p><a target="_blank" rel="noopener noreferrer" href="https://github.com/user-attachments/assets/52c40b4a-21b7-4058-9509-d867751068fd"><img src="https://github.com/user-attachments/assets/52c40b4a-21b7-4058-9509-d867751068fd" alt="QQ20240825-095604" style="max-width: 100%;"></a><br>
可以看到上传成功。</p>
<h2>检验</h2>
<p>打开我们的网站upload-labs文件的upload文件夹，可以看到上传成功。<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/user-attachments/assets/1258744d-5be1-43a1-ad34-b0d2f1f39c2e"><img src="https://github.com/user-attachments/assets/1258744d-5be1-43a1-ad34-b0d2f1f39c2e" alt="QQ20240825-095928" style="max-width: 100%;"></a></p>
<p>右键查看文件属性，可以看到我们虽然在后缀名最后加了空格，但是windows操作系统依然将其视为php文件。<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/user-attachments/assets/014f8324-94cc-4efc-b563-d4623bffa7d1"><img src="https://github.com/user-attachments/assets/014f8324-94cc-4efc-b563-d4623bffa7d1" alt="QQ20240825-095941" style="max-width: 100%;"></a></p>
<p>最后通过中国蚁剑进行连接。<br>
<a target="_blank" rel="noopener noreferrer" href="https://github.com/user-attachments/assets/775c8bd3-4a0d-4fa3-b280-b440f865fb57"><img src="https://github.com/user-attachments/assets/775c8bd3-4a0d-4fa3-b280-b440f865fb57" alt="QQ20240825-100353" style="max-width: 100%;"></a><br>
成功！</p></div>
<div style="font-size:small;margin-top:8px;float:right;"></div>

<button class="btn btn-block" type="button" onclick="openComments()" id="cmButton">评论</button>
<div class="comments" id="comments"></div>

</div>
    <div id="footer"><div id="footer1">Copyright © <span id="copyrightYear"></span> <a href="https://kytota.github.io">网络保安养成</a></div>
<div id="footer2">
    <span id="runday"></span><span>Powered by <a href="https://meekdai.com/Gmeek.html" target="_blank">Gmeek</a></span>
</div>

<script>
var now=new Date();
document.getElementById("copyrightYear").innerHTML=now.getFullYear();

if(""!=""){
    var startSite=new Date("");
    var diff=now.getTime()-startSite.getTime();
    var diffDay=Math.floor(diff/(1000*60*60*24));
    document.getElementById("runday").innerHTML="网站运行"+diffDay+"天"+" • ";
}
</script></div>
</body>
<script>
var IconList={'sun': 'M8 10.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5zM8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0V.75A.75.75 0 018 0zm0 13a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 018 13zM2.343 2.343a.75.75 0 011.061 0l1.06 1.061a.75.75 0 01-1.06 1.06l-1.06-1.06a.75.75 0 010-1.06zm9.193 9.193a.75.75 0 011.06 0l1.061 1.06a.75.75 0 01-1.06 1.061l-1.061-1.06a.75.75 0 010-1.061zM16 8a.75.75 0 01-.75.75h-1.5a.75.75 0 010-1.5h1.5A.75.75 0 0116 8zM3 8a.75.75 0 01-.75.75H.75a.75.75 0 010-1.5h1.5A.75.75 0 013 8zm10.657-5.657a.75.75 0 010 1.061l-1.061 1.06a.75.75 0 11-1.06-1.06l1.06-1.06a.75.75 0 011.06 0zm-9.193 9.193a.75.75 0 010 1.06l-1.06 1.061a.75.75 0 11-1.061-1.06l1.06-1.061a.75.75 0 011.061 0z', 'moon': 'M9.598 1.591a.75.75 0 01.785-.175 7 7 0 11-8.967 8.967.75.75 0 01.961-.96 5.5 5.5 0 007.046-7.046.75.75 0 01.175-.786zm1.616 1.945a7 7 0 01-7.678 7.678 5.5 5.5 0 107.678-7.678z', 'sync': 'M1.705 8.005a.75.75 0 0 1 .834.656 5.5 5.5 0 0 0 9.592 2.97l-1.204-1.204a.25.25 0 0 1 .177-.427h3.646a.25.25 0 0 1 .25.25v3.646a.25.25 0 0 1-.427.177l-1.38-1.38A7.002 7.002 0 0 1 1.05 8.84a.75.75 0 0 1 .656-.834ZM8 2.5a5.487 5.487 0 0 0-4.131 1.869l1.204 1.204A.25.25 0 0 1 4.896 6H1.25A.25.25 0 0 1 1 5.75V2.104a.25.25 0 0 1 .427-.177l1.38 1.38A7.002 7.002 0 0 1 14.95 7.16a.75.75 0 0 1-1.49.178A5.5 5.5 0 0 0 8 2.5Z', 'home': 'M6.906.664a1.749 1.749 0 0 1 2.187 0l5.25 4.2c.415.332.657.835.657 1.367v7.019A1.75 1.75 0 0 1 13.25 15h-3.5a.75.75 0 0 1-.75-.75V9H7v5.25a.75.75 0 0 1-.75.75h-3.5A1.75 1.75 0 0 1 1 13.25V6.23c0-.531.242-1.034.657-1.366l5.25-4.2Zm1.25 1.171a.25.25 0 0 0-.312 0l-5.25 4.2a.25.25 0 0 0-.094.196v7.019c0 .138.112.25.25.25H5.5V8.25a.75.75 0 0 1 .75-.75h3.5a.75.75 0 0 1 .75.75v5.25h2.75a.25.25 0 0 0 .25-.25V6.23a.25.25 0 0 0-.094-.195Z', 'github': 'M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z', 'copy': 'M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z', 'check': 'M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z'};
var utterancesLoad=0;

let themeSettings={
    "dark": ["dark","moon","#00f0ff","dark-blue"],
    "light": ["light","sun","#ff5000","github-light"],
    "auto": ["auto","sync","","preferred-color-scheme"]
};
function changeTheme(mode, icon, color, utheme){
    document.documentElement.setAttribute("data-color-mode",mode);
    document.getElementById("themeSwitch").setAttribute("d",value=IconList[icon]);
    document.getElementById("themeSwitch").parentNode.style.color=color;
    if(utterancesLoad==1){utterancesTheme(utheme);}
}
function modeSwitch(){
    let currentMode=document.documentElement.getAttribute('data-color-mode');
    let newMode = currentMode === "light" ? "dark" : currentMode === "dark" ? "auto" : "light";
    localStorage.setItem("meek_theme", newMode);
    if(themeSettings[newMode]){
        changeTheme(...themeSettings[newMode]);
    }
}
function utterancesTheme(theme){
    const message={type:'set-theme',theme: theme};
    const iframe=document.getElementsByClassName('utterances-frame')[0];
    iframe.contentWindow.postMessage(message,'https://utteranc.es');
}
if(themeSettings[theme]){changeTheme(...themeSettings[theme]);}
console.log("\n %c Gmeek last https://github.com/Meekdai/Gmeek \n","padding:5px 0;background:#02d81d;color:#fff");
</script>

<script>
document.getElementById("pathHome").setAttribute("d",IconList["home"]);
document.getElementById("pathIssue").setAttribute("d",IconList["github"]);
cmButton=document.getElementById("cmButton");
    span=document.createElement("span");
    span.setAttribute("class","Counter");
    span.innerHTML="8";
    cmButton.appendChild(span);


function openComments(){
    cm=document.getElementById("comments");
    cmButton=document.getElementById("cmButton");
    cmButton.innerHTML="loading";
    span=document.createElement("span");
    span.setAttribute("class","AnimatedEllipsis");
    cmButton.appendChild(span);

    script=document.createElement("script");
    script.setAttribute("src","https://utteranc.es/client.js");
    script.setAttribute("repo","kytota/kytota.github.io");
    script.setAttribute("issue-term","title");
    
    if(localStorage.getItem("meek_theme")=="dark"){script.setAttribute("theme","dark-blue");}
    else if(localStorage.getItem("meek_theme")=="light") {script.setAttribute("theme","github-light");}
    else{script.setAttribute("theme","preferred-color-scheme");}
    
    script.setAttribute("crossorigin","anonymous");
    script.setAttribute("async","");
    cm.appendChild(script);

    int=self.setInterval("iFrameLoading()",200);
}

function iFrameLoading(){
    var utterances=document.getElementsByClassName('utterances');
    if(utterances.length==1){
        if(utterances[0].style.height!=""){
            utterancesLoad=1;
            int=window.clearInterval(int);
            document.getElementById("cmButton").style.display="none";
            console.log("utterances Load OK");
        }
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const createClipboardHTML = (codeContent, additionalClasses = '') => `
        <pre class="notranslate"><code class="notranslate">${codeContent}</code></pre>
        <div class="clipboard-container position-absolute right-0 top-0 ${additionalClasses}">
            <clipboard-copy class="ClipboardButton btn m-2 p-0" role="button" style="display: inherit;">
                <svg height="16" width="16" class="octicon octicon-copy m-2"><path d="${IconList["copy"]}"></path></svg>
                <svg height="16" width="16" class="octicon octicon-check color-fg-success m-2 d-none"><path d="${IconList["check"]}"></path></svg>
            </clipboard-copy>
            <div class="copy-feedback">Copied!</div>
        </div>
    `;

    const handleCodeElements = (selector = '') => {
        document.querySelectorAll(selector).forEach(codeElement => {
            const codeContent = codeElement.innerHTML;
            const newStructure = document.createElement('div');
            newStructure.className = 'snippet-clipboard-content position-relative overflow-auto';
            newStructure.innerHTML = createClipboardHTML(codeContent);

            const parentElement = codeElement.parentElement;
            if (selector.includes('highlight')) {
                parentElement.insertBefore(newStructure, codeElement.nextSibling);
                parentElement.removeChild(codeElement);
            } else {
                parentElement.parentElement.replaceChild(newStructure, parentElement);
            }
        });
    };

    handleCodeElements('pre.notranslate > code.notranslate');
    handleCodeElements('div.highlight > pre.notranslate');

    let currentFeedback = null;
    document.querySelectorAll('clipboard-copy').forEach(copyButton => {
        copyButton.addEventListener('click', () => {
            const codeContent = copyButton.closest('.snippet-clipboard-content').innerText;
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = codeContent;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextArea);

            const copyIcon = copyButton.querySelector('.octicon-copy');
            const checkIcon = copyButton.querySelector('.octicon-check');
            const copyFeedback = copyButton.nextElementSibling;

            if (currentFeedback && currentFeedback !== copyFeedback) {currentFeedback.style.display = 'none';}
            currentFeedback = copyFeedback;

            copyIcon.classList.add('d-none');
            checkIcon.classList.remove('d-none');
            copyFeedback.style.display = 'block';
            copyButton.style.borderColor = 'var(--color-success-fg)';

            setTimeout(() => {
                copyIcon.classList.remove('d-none');
                checkIcon.classList.add('d-none');
                copyFeedback.style.display = 'none';
                copyButton.style.borderColor = '';
            }, 2000);
        });
    });
});

</script>


</html>
